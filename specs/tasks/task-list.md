# 任务列表：飞书图片发送修复工具

## 任务分解

### Phase 1: 项目初始化 (优先级: P0)

#### TASK-001: 创建项目结构
- **描述**: 创建项目目录结构和基础配置文件
- **文件**:
  - `package.json`
  - `tsconfig.json`
  - `.gitignore`
- **验收标准**: 项目可以通过 `npm install` 安装依赖
- **工时**: 0.5h

#### TASK-002: 定义类型
- **描述**: 创建 TypeScript 类型定义
- **文件**: `src/types/index.ts`
- **内容**:
  - `PatchConfig` 接口
  - `FixResult` 接口
  - `CheckResult` 接口
  - `FixerError` 枚举
- **验收标准**: 类型可以被其他模块引用
- **工时**: 0.5h

#### TASK-003: 实现日志工具
- **描述**: 创建日志输出工具
- **文件**: `src/utils/logger.ts`
- **功能**:
  - 支持多级别日志 (INFO, WARN, ERROR, DEBUG)
  - 支持颜色输出
  - 支持时间戳
- **验收标准**: 日志格式符合规范
- **工时**: 1h

### Phase 2: 核心功能 (优先级: P0)

#### TASK-004: 实现问题检测器
- **描述**: 创建问题检测逻辑
- **文件**: `src/core/detector.ts`
- **功能**:
  - 定位 OpenClaw 安装路径
  - 定位目标文件
  - 检测是否已修复
  - 返回检测结果
- **依赖**: TASK-002
- **验收标准**: 能正确检测已修复和未修复状态
- **工时**: 2h

#### TASK-005: 实现备份管理器
- **描述**: 创建文件备份和恢复逻辑
- **文件**: `src/core/backup.ts`
- **功能**:
  - 创建备份文件（带时间戳）
  - 恢复备份文件
  - 列出所有备份
  - 清理旧备份
- **依赖**: TASK-003
- **验收标准**: 备份和恢复正常工作
- **工时**: 1.5h

#### TASK-006: 实现补丁应用器
- **描述**: 创建补丁应用逻辑
- **文件**: `src/core/patcher.ts`
- **功能**:
  - 添加 import 语句
  - 添加媒体发送逻辑
  - 验证补丁正确性
- **依赖**: TASK-002, TASK-004
- **验收标准**: 补丁能正确应用
- **工时**: 2h

#### TASK-007: 实现服务管理
- **描述**: 创建 systemd 服务管理逻辑
- **文件**: `src/utils/service.ts`
- **功能**:
  - 检查服务状态
  - 重启服务
  - 等待服务就绪
- **验收标准**: 能正确管理服务
- **工时**: 1h

### Phase 3: CLI 命令 (优先级: P0)

#### TASK-008: 实现 check 命令
- **描述**: 创建检测命令
- **文件**: `src/commands/check.ts`
- **功能**:
  - 调用检测器
  - 格式化输出结果
  - 返回正确的退出码
- **依赖**: TASK-004
- **验收标准**: 命令能正确检测问题
- **工时**: 1h

#### TASK-009: 实现 fix 命令
- **描述**: 创建修复命令
- **文件**: `src/commands/fix.ts`
- **功能**:
  - 调用检测器
  - 调用备份管理器
  - 调用补丁应用器
  - 重启服务
  - 验证修复
- **依赖**: TASK-004, TASK-005, TASK-006, TASK-007
- **验收标准**: 命令能正确修复问题
- **工时**: 1.5h

#### TASK-010: 实现 undo 命令
- **描述**: 创建撤销命令
- **文件**: `src/commands/undo.ts`
- **功能**:
  - 检查备份文件
  - 恢复备份
  - 重启服务
- **依赖**: TASK-005, TASK-007
- **验收标准**: 命令能正确撤销修复
- **工时**: 1h

#### TASK-011: 实现 status 命令
- **描述**: 创建状态查看命令
- **文件**: `src/commands/status.ts`
- **功能**:
  - 显示当前状态
  - 显示 OpenClaw 版本
  - 显示备份文件信息
- **依赖**: TASK-004
- **验收标准**: 命令能正确显示状态
- **工时**: 0.5h

#### TASK-012: 实现 CLI 入口
- **描述**: 创建 CLI 主入口
- **文件**: `src/index.ts`, `bin/openclaw-feishu-fixer`
- **功能**:
  - 解析命令行参数
  - 分发到对应命令
  - 全局错误处理
- **依赖**: TASK-008 ~ TASK-011
- **验收标准**: CLI 可正常使用
- **工时**: 1h

### Phase 4: 测试与文档 (优先级: P1)

#### TASK-013: 单元测试
- **描述**: 编写单元测试
- **文件**: `tests/*.test.ts`
- **内容**:
  - 检测器测试
  - 补丁应用器测试
  - 备份管理器测试
- **依赖**: TASK-004, TASK-005, TASK-006
- **验收标准**: 测试覆盖率 >= 80%
- **工时**: 2h

#### TASK-014: 集成测试
- **描述**: 编写端到端测试
- **文件**: `tests/integration.test.ts`
- **内容**:
  - 完整修复流程测试
  - 撤销流程测试
- **依赖**: TASK-013
- **验收标准**: 所有流程正常工作
- **工时**: 1.5h

#### TASK-015: 编写文档
- **描述**: 创建项目文档
- **文件**: `README.md`
- **内容**:
  - 项目介绍
  - 安装说明
  - 使用示例
  - 故障排除
- **验收标准**: 文档清晰易懂
- **工时**: 1h

## 任务依赖图

```
TASK-001 ──┬──> TASK-002 ──┬──> TASK-004 ──┬──> TASK-008
           │               │               │
           │               └──> TASK-006 ──┼──> TASK-009
           │                               │
           └──> TASK-003 ──> TASK-005 ─────┤
                                           │
                           TASK-007 ───────┤
                                           │
                                           ├──> TASK-010
                                           │
                                           └──> TASK-011 ──> TASK-012

TASK-004, TASK-005, TASK-006 ──> TASK-013 ──> TASK-014
TASK-012 ──> TASK-015
```

## 工时估算

| Phase | 任务数 | 预计工时 |
|-------|--------|----------|
| Phase 1 | 3 | 2h |
| Phase 2 | 4 | 6.5h |
| Phase 3 | 5 | 5h |
| Phase 4 | 3 | 4.5h |
| **总计** | **15** | **18h** |

## 里程碑

- **M1**: 项目框架完成 (Phase 1)
- **M2**: 核心功能完成 (Phase 2)
- **M3**: CLI 可用 (Phase 3)
- **M4**: 发布就绪 (Phase 4)
